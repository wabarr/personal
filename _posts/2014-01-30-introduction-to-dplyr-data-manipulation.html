---
layout: post
title: 'Introduction to dplyr: data manipulation made easy(er) and fun(er)'
date: '2014-01-30T15:10:00.002-06:00'
author: Andrew Barr
tags:
- R Tips
modified_time: '2015-01-13T09:40:24.706-06:00'
thumbnail: http://2.bp.blogspot.com/-Pt-oWOP4-_0/Uuq95U-UjDI/AAAAAAAAOdU/gHIDNAGwYKc/s72-c/unnamed-chunk-2.png
blogger_id: tag:blogger.com,1999:blog-9204176314411862946.post-6018683772981791597
blogger_orig_url: http://www.ancienteco.com/2014/01/introduction-to-dplyr-data-manipulation.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: left;"></div><h2 style="text-align: left;"><b>UPDATE 01/13/15: This post is not up to date with the most current version of dplyr. &nbsp;</b></h2><br /><div style="text-align: left;">Major differences include a new pipe operator (i.e. all instances of <span style="font-family: Courier New, Courier, monospace;">%.%</span>. below should be <span style="font-family: Courier New, Courier, monospace;">%&gt;%</span>). There are likely other differences as well.&nbsp;</div><h2 style="text-align: left;"><b>If you are just getting started in R, checkout <a href="http://www.ancienteco.com/2013/02/getting-started-with-r.html">my post on good references for beginners</a>.&nbsp;</b></h2><br /><a href="http://had.co.nz/">Hadley Wickham</a> has come out with yet another R package that is destined to improve my workflow and let me concentrate less on getting R to do things, and more on my research questions. The package is <a href="http://blog.rstudio.org/2014/01/17/introducing-dplyr/">dplyr</a>, a reboot of an earlier package called plyr. <br /><br />Behind both packages is the notion that it should be easy to do split-apply-combine operations on your data. These operations are where you group your observations by some categorical variable, do the some operation on each subset, and then recombine results. &nbsp;The plyr package was already really good at this. <br /><br />From my perspective, the 2 most important improvements in dplyr are<br /><ol style="text-align: left;"><li>a MASSIVE increase in speed, making dplyr useful on big data sets<br /><br /><ol></ol></li><li>the ability to chain operations together in a natural order</li></ol><div>Here is a quick example of how you can do complicated stuff with dplyr. Example data are from the <a href="http://esapubs.org/archive/ecol/e090/184/">PanTHERIA</a><sup>1</sup> dataset of life history traits across mammals.<br /><br />First, we read in the data from the web. &nbsp;This step takes the longest of anything we will do, because we are reading a 2.5 MB text file into memory over http. It is a huge dataset with&nbsp;5416 observations of &nbsp;55 variables<br /><b><br /></b><b>Edit: make sure you are using the most recent version of dplyr (0.1.1), or else you may have issues with your R session crashing.</b><br /><br /><span style="font-family: Courier New, Courier, monospace;">require(dplyr)</span><br /><span style="font-family: Courier New, Courier, monospace;">URL &lt;-&nbsp;<span style="line-height: 21.600000381469727px; text-indent: -32px;">"http://esapubs.org/archive/ecol/e090/184/PanTHERIA_1-0_WR05_Aug2008.txt"</span></span></div><div><span style="font-family: Courier New, Courier, monospace; line-height: 21.600000381469727px; text-indent: -2em;">pantheria &lt;- read.table(file=URL,header=TRUE,sep="\t",na.strings=c("-999","-999.00"))</span><br /><br /></div><div>Next we will set up some factors with human readable levels. &nbsp;Note that our variables aren't named very concisely, but we will leave them for now.<br /><br /><span style="font-family: Courier New, Courier, monospace; text-indent: -2em;"><span style="line-height: 21.600000381469727px;">pantheria$X1.1_ActivityCycle &lt;- &nbsp; &nbsp; &nbsp;&nbsp;</span></span><br /><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;factor(pantheria$X1.1_ActivityCycle)</span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="text-indent: -2em;"><span style="line-height: 21.600000381469727px;">levels(</span></span><span style="line-height: 21.600000381469727px; text-indent: -32px;">pantheria$X1.1_ActivityCycle)&nbsp;</span><span style="text-indent: -2em;"><span style="line-height: 21.600000381469727px;">&lt;-&nbsp;</span></span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px; text-indent: -32px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c("nocturnal","cathermeral","diurnal")</span></span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;"><span style="text-indent: -2em;"><span style="line-height: 21.600000381469727px;">pantheria$X6.2_TrophicLevel &lt;-</span></span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="text-indent: -2em;"><span style="line-height: 21.600000381469727px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;factor(</span></span><span style="line-height: 21.600000381469727px; text-indent: -32px;">pantheria$X6.2_TrophicLevel</span><span style="line-height: 21.600000381469727px; text-indent: -2em;">)</span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px; text-indent: -32px;">levels(</span><span style="line-height: 21.600000381469727px; text-indent: -32px;">pantheria$X6.2_TrophicLevel</span><span style="line-height: 21.600000381469727px; text-indent: -32px;">) &lt;-&nbsp;</span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px; text-indent: -32px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c("herbivore","omnivore","carnivore")</span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px; text-indent: -32px;"><br /></span></span>OK. &nbsp;Now we are ready to show off the magic of dplyr. &nbsp;We will use the %.%. operator to chain together commands to manipulate our dataframe. &nbsp;First, we use the <span style="font-family: Courier New, Courier, monospace;">mutate()</span>function to create a new column called yearlyOffspring, which is a transformation of two other columns. &nbsp;Then, we pass that result to the filter function, and filter out just the rodents. Next, we add a <span style="font-family: Courier New, Courier, monospace;">group_by()</span> clause, and finally, we use <span style="font-family: Courier New, Courier, monospace;">summarise()</span>, to calculate the average body mass for each group. Type <span style="font-family: Courier New, Courier, monospace;">?manip</span> in the command line to see the full list of dplyr manipulation functions.<br /><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;"><br /></span></span><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;">Activity_Trophic &lt;-</span></span><br /><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;">pantheria %.%&nbsp;</span></span><br /><span style="font-family: 'Courier New', Courier, monospace; line-height: 21.600000381469727px; text-indent: -2em;">&nbsp; &nbsp; mutate(yearlyOffspring =</span><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px;">&nbsp;X16.1_LittersPerYear&nbsp;</span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *&nbsp;</span></span><span style="font-family: 'Courier New', Courier, monospace; line-height: 21.600000381469727px;">X16.1_LittersPerYear) %.%</span><br /><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; filter(</span></span><span style="font-family: Courier New, Courier, monospace;"><span style="line-height: 21.600000381469727px;">MSW05_Order == "Rodentia"</span></span><span style="font-family: 'Courier New', Courier, monospace; line-height: 21.600000381469727px; text-indent: -2em;">) %.%</span><br /><div style="text-indent: 0px;"><span style="font-family: 'Courier New', Courier, monospace; line-height: 21.600000381469727px;">&nbsp; &nbsp;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace; line-height: 21.600000381469727px; text-indent: -32px;">group_by(X1.1_ActivityCycle,X6.2_TrophicLevel) %.%&nbsp;</span></div><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; summarise(meanBM = mean(X5.1_AdultBodyMass_g,na.rm=TRUE),&nbsp;</span></span><br /><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; meanYO = mean(yearlyOffspring,na.rm=TRUE))</span></span><br /><span style="line-height: 21.600000381469727px; text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace;"><br /></span></span><span style="line-height: 1.35; text-indent: -2em;">This code yields the following, which is exactly what we want!</span><br /><span style="line-height: 1.35; text-indent: -2em;"><br /></span><span class="Apple-style-span" style="background-color: white; border-collapse: separate; border-spacing: 0px; font-family: Monaco, 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, monospace; font-size: 12px; white-space: pre-wrap;">## Source: local data frame [16 x 4] ## Groups: X1.1_ActivityCycle ##  ##    X1.1_ActivityCycle X6.2_TrophicLevel  meanBM meanYO ## 1           nocturnal         carnivore   77.89 11.125 ## 2         cathermeral         carnivore  227.89  6.250 ## 3             diurnal         carnivore   88.34    NaN ## 4         cathermeral          omnivore  306.65  5.947 ## 5             diurnal         herbivore 1088.98  9.289 ## 6         cathermeral                NA   97.97 15.526 ## 7                  NA         carnivore   51.35 20.250 ## 8         cathermeral         herbivore 2625.65 14.154 ## 9           nocturnal         herbivore 1172.53  9.793 ## 10            diurnal                NA  364.47 21.415 ## 11          nocturnal          omnivore  542.24  9.741 ## 12                 NA          omnivore  392.19  5.079 ## 13          nocturnal                NA  205.08 16.200 ## 14                 NA         herbivore  452.95  6.264 ## 15            diurnal          omnivore  300.05  3.438 ## 16                 NA                NA  220.48 11.508</span><br /><span style="text-indent: -2em;"><span style="font-family: Monaco, DejaVu Sans Mono, Droid Sans Mono, Lucida Console, Consolas, monospace;"><span style="font-size: 12px; white-space: pre-wrap;"><br /></span></span></span><span style="text-indent: -2em;"><span style="white-space: pre-wrap;"><span style="font-family: inherit;">The beauty of the %.% operator is that it allows you to do things in the order in which you think about them.  You start with your data, then mutate it, then filter it, then group and summarise.  You could do the same process with plyr, or with base apply-family functions, but dplyr makes it MUCH cleaner and clearer. &nbsp;</span></span></span><br /><span style="text-indent: -2em;"><span style="white-space: pre-wrap;"><br /></span></span><span style="text-indent: -2em;"><span style="white-space: pre-wrap;">Now we can visualize this data, and observe that there is a complex relationship between body mass and reproductive output in rodents! </span></span><br /><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">require(ggplot2)</span></span><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">qplot(data = Activity_Trophic,&nbsp;</span></span><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">      x = log(meanBM),&nbsp;</span></span><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">      y = meanYO,&nbsp;</span></span><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">      size = I(5),&nbsp;</span></span><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">      shape = X1.1_ActivityCycle) +&nbsp;</span></span><br /><span style="text-indent: -2em;"><span style="font-family: Courier New, Courier, monospace; white-space: pre-wrap;">theme_bw(15)</span></span><br /><span style="text-indent: -2em;"><span style="white-space: pre-wrap;"><br /></span></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Pt-oWOP4-_0/Uuq95U-UjDI/AAAAAAAAOdU/gHIDNAGwYKc/s1600/unnamed-chunk-2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-Pt-oWOP4-_0/Uuq95U-UjDI/AAAAAAAAOdU/gHIDNAGwYKc/s1600/unnamed-chunk-2.png" height="250" width="400" /></a></div><span style="text-indent: -2em;"><span style="white-space: pre-wrap;"><br /></span></span><br /><h3 style="text-align: left;"><span style="text-indent: -2em;"><span style="white-space: pre-wrap;">Please share your experiences with dplyr in the comments section.</span></span></h3><span style="line-height: 1.35; text-indent: -2em;"><br /></span><span style="line-height: 1.35; text-indent: -2em;"><b>References</b>:</span></div><div><span style="line-height: 1.35; text-indent: -2em;"><sup>1</sup>Jones KE, Bielby J, Cardillo M, Fritz SA, O’Dell J, Orme CDL, Safi K, Sechrest W, Boakes EH, &nbsp; Carbone C, et al. 2009. PanTHERIA: a species-level database of life history, ecology, and geography of extant and recently extinct mammals. Ecology 90:2648.</span></div><div class="csl-bib-body" style="line-height: 1.35; padding-left: 2em; text-indent: -2em;"><span class="Z3988" title="url_ver=Z39.88-2004&amp;ctx_ver=Z39.88-2004&amp;rfr_id=info%3Asid%2Fzotero.org%3A2&amp;rft_id=info%3Adoi%2F10.1890%2F08-1494.1&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Ajournal&amp;rft.genre=article&amp;rft.atitle=PanTHERIA%3A%20a%20species-level%20database%20of%20life%20history%2C%20ecology%2C%20and%20geography%20of%20extant%20and%20recently%20extinct%20mammals&amp;rft.jtitle=Ecology&amp;rft.volume=90&amp;rft.issue=9&amp;rft.aufirst=Kate%20E.&amp;rft.aulast=Jones&amp;rft.au=Kate%20E.%20Jones&amp;rft.au=Jon%20Bielby&amp;rft.au=Marcel%20Cardillo&amp;rft.au=Susanne%20A.%20Fritz&amp;rft.au=Justin%20O'Dell&amp;rft.au=C.%20David%20L.%20Orme&amp;rft.au=Kamran%20Safi&amp;rft.au=Wes%20Sechrest&amp;rft.au=Elizabeth%20H.%20Boakes&amp;rft.au=Chris%20Carbone&amp;rft.au=Christina%20Connolly&amp;rft.au=Michael%20J.%20Cutts&amp;rft.au=Janine%20K.%20Foster&amp;rft.au=Richard%20Grenyer&amp;rft.au=Michael%20Habib&amp;rft.au=Christopher%20A.%20Plaster&amp;rft.au=Samantha%20A.%20Price&amp;rft.au=Elizabeth%20A.%20Rigby&amp;rft.au=Janna%20Rist&amp;rft.au=Amber%20Teacher&amp;rft.au=Olaf%20R.%20P.%20Bininda-Emonds&amp;rft.au=John%20L.%20Gittleman&amp;rft.au=Georgina%20M.%20Mace&amp;rft.au=Andy%20Purvis&amp;rft.au=W.%20K.%20Michener&amp;rft.date=2009&amp;rft.pages=2648&amp;rft.issn=0012-9658"></span></div></div>